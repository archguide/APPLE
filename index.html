<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.apple-mapkit.com/mk/5.x.x/mapkit.js" crossorigin></script>

  <style>
    html, body, #map { margin:0; padding:0; height:100%; width:100%; }

    .building-callout {
      width:155px;
      height:155px;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
    }
    .building-callout img {
      width:100%;
      height:100%;
      object-fit:cover;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
const SUPABASE_URL = 'https://msuzmrfzzkqffhpilirb.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_KEY';

const NEIGHBORHOODS = [
  { id:'DTL', name:'Downtown LA', center:{latitude:34.0407, longitude:-118.2468}, radius:1800, color:'#1150AB' },
  { id:'SLV', name:'Silver Lake', center:{latitude:34.0864, longitude:-118.2709}, radius:1400, color:'#2E7D6F' },
  { id:'PAS', name:'Pasadena', center:{latitude:34.1478, longitude:-118.1445}, radius:1600, color:'#C56B3C' }
];

let selectedNeighborhood = null;
let buildingAnnotations = [];

mapkit.init({
  authorizationCallback: done => done('YOUR_MAPKIT_TOKEN')
});

const map = new mapkit.Map("map", {
  center: new mapkit.Coordinate(34.0522,-118.2437),
  region: new mapkit.CoordinateRegion(
    new mapkit.Coordinate(34.0522,-118.2437),
    new mapkit.CoordinateSpan(0.25,0.35)
  )
});

// draw circles
NEIGHBORHOODS.forEach(n => {
  map.addOverlay(new mapkit.CircleOverlay(
    new mapkit.Coordinate(n.center.latitude,n.center.longitude),
    n.radius,
    { style: new mapkit.Style({
        strokeColor:n.color, fillColor:n.color,
        strokeOpacity:.6, fillOpacity:.12, lineWidth:2.5
    })}
  ));
});

function metersBetween(a,b){
  const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(b.latitude-a.latitude);
  const dLng=toRad(b.longitude-a.longitude);
  const x=Math.sin(dLat/2)**2+
    Math.cos(toRad(a.latitude))*Math.cos(toRad(b.latitude))*
    Math.sin(dLng/2)**2;
  return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

async function showBuildings(n){
  buildingAnnotations.forEach(a=>map.removeAnnotation(a));
  buildingAnnotations=[];

  const res = await fetch(
    `${SUPABASE_URL}/rest/v1/buildings?neighborhood_id=eq.${n.id}&select=id,title,latitude,longitude,image`,
    { headers:{apikey:SUPABASE_ANON_KEY,Authorization:`Bearer ${SUPABASE_ANON_KEY}`} }
  );
  const buildings = await res.json();

  buildings.forEach(b=>{
    if(!b.latitude||!b.longitude) return;
    const ann = new mapkit.MarkerAnnotation(
      new mapkit.Coordinate(+b.latitude,+b.longitude),
      { color:n.color, data:b }
    );
    ann.callout = {
      calloutElementForAnnotation: a => {
        const el=document.createElement('div');
        el.className='building-callout';
        el.innerHTML=b.image?`<img src="${b.image}">`:`<div>No Image</div>`;
        el.onclick=()=>window.ReactNativeWebView?.postMessage(
          JSON.stringify({action:'navigateToBuilding',buildingId:b.id})
        );
        return el;
      }
    };
    map.addAnnotation(ann);
    buildingAnnotations.push(ann);
  });
}

map.addEventListener('single-tap', async e => {
  const coord=e.coordinate;

  if(selectedNeighborhood){
    map.setRegionAnimated(
      new mapkit.CoordinateRegion(
        new mapkit.Coordinate(34.0522,-118.2437),
        new mapkit.CoordinateSpan(0.25,0.35)
      ), true
    );
    buildingAnnotations.forEach(a=>map.removeAnnotation(a));
    buildingAnnotations=[];
    selectedNeighborhood=null;
    return;
  }

  for(const n of NEIGHBORHOODS){
    if(metersBetween(coord,n.center)<=n.radius){
      selectedNeighborhood=n;
      map.setRegionAnimated(
        new mapkit.CoordinateRegion(
          new mapkit.Coordinate(n.center.latitude,n.center.longitude),
          new mapkit.CoordinateSpan(0.05,0.05)
        ), true
      );
      await showBuildings(n);
      break;
    }
  }
});
</script>
</body>
</html>
